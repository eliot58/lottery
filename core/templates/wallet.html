{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=400, user-scalable=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <style>
        a {
            color: #D3D3D3;
        }
    </style>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <title>Wallet</title>
</head>
<body>
    <div class="container" style="height: 100%;">
        <div class="d-flex flex-column justify-content-between" style="padding: 40px 0px;">
            <div class="d-flex flex-column">
                <div class="d-flex justify-content-between">
                    <img src="{% static 'img/logo.svg' %}" width="100" height="100" alt="">
                    <div class="d-flex flex-column align-items-end">
                        <h1 style="font-size: 36px; font-weight: 700;">SRP LOTTERY</h1>
                        <div class="d-flex navbar">
                            <a href="{% url 'tickets' %}">My tickets</a>
                            <a href="{% url 'mint' %}" style="margin-left: 20px;">Store</a>
                            <a href="{% url 'index' %}" style="margin-left: 20px;">Info</a>
                        </div>
                    </div>
                </div>
                <div style="margin: 20px; line-height: 24px; font-size: 14px;">
                    We invite you to take part in the first season of an exciting game, which consists of searching for the secret phrase for restoring a wallet containing a certain amount of $TON. <br>
                    The conditions are as follows: <br>
                    The prize fund is 2500 $TON. <br>
                    <a href="{% url 'tables' %}">Balance distribution table.</a> <br>
                    Each phrase is duplicated 24 times. <br>
                    Each word of the secret phrase is hidden in NFT tickets. <br>
                    You can see the phrase only when you collect all the words. <br>
                    You can check the distribution of the found secret words in your collection on the corresponding page, available after connecting your wallet. <br>
                    After purchasing a basic set of NFT tickets, or more to increase your chances of winning, you need to decide which phrases you will continue searching for and which tickets you need to sell on the secondary market. <br>
                    There is a 10% royalty on the secondary market. 50% of the royalty goes into the prize game fund, which will be drawn after the last secret phrase is found. <br>
                    ❗️ Follow the messages in the bot. <br>
                    To avoid unfair play, tickets are distributed in waves after a certain number of tickets have been sold: <br>
                    <a href="{% url 'tables' %}">Wave distribution table.</a> <br>
                </div>
            </div>
            <div style="text-align: center; display: none;" class="inner-connect">
                <img style="width: 80%; cursor: pointer;" class="connect" src="{% static 'img/continue.svg' %}" alt="">
            </div>
            <div class="inner-disconnect" style="text-align: center; display: none;">
                <div style="font-size: 18px;">Now connected:</div>
                <div class="address" id="address" style="font-size: 20px; margin-bottom: 10px;"></div>
                <img class="disconnect" style="width: 80%; cursor: pointer;" src="{% static 'img/disconnect.svg' %}" alt="">
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="{% static 'dist/tonweb.js' %}"></script>
    <script>

        let tg = window.Telegram.WebApp;

        tg.expand();

        const tonweb = new TonWeb();
        const Address = TonWeb.Address;

        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://srplottery.online/static/tonconnect.json',
            language: 'ru',
            restoreConnection: true
        });

        const connect = document.querySelector(".connect")

        connect.addEventListener("click", async function(){
            await tonConnectUI.openModal();
        })

        const disconnect = document.querySelector(".disconnect")

        disconnect.addEventListener("click", async function(){
            await tonConnectUI.disconnect();
        })

        function statusChange(address) {
            if (!tonConnectUI.connected) {
                for (const nav of document.querySelectorAll(".navbar a")){
                    nav.style.display = "none"
                }
                document.querySelector(".inner-connect").style.display = "block"
                document.querySelector(".inner-disconnect").style.display = "none"
            } else {
                for (const nav of document.querySelectorAll(".navbar a")){
                    nav.style.display = "block"
                }
                document.querySelector(".inner-connect").style.display = "none"
                let str = new Address(address).toString(true, true, true)
                let result = str.slice(0, 10) + " . . . . . . . . . " + str.slice(str.length - 10);
                document.querySelector("#address").textContent = result
                document.querySelector(".inner-disconnect").style.display = "block"
            }
        }

        tonConnectUI.connectionRestored.then(restored => {
            if (restored) {
                for (const nav of document.querySelectorAll(".navbar a")){
                    nav.style.display = "block"
                }
                document.querySelector(".inner-connect").style.display = "none"
                let str = new Address(tonConnectUI.walletInfo.account.address).toString(true, true, true)
                let result = str.slice(0, 10) + " . . . . . . . . . " + str.slice(str.length - 10);
                document.querySelector("#address").textContent = result
                document.querySelector(".inner-disconnect").style.display = "block"
            } else {
                for (const nav of document.querySelectorAll(".navbar a")){
                    nav.style.display = "none"
                }
                document.querySelector(".inner-connect").style.display = "block"
                document.querySelector(".inner-disconnect").style.display = "none"
            }
        });



        const unsubscribe = tonConnectUI.onStatusChange(
            walletAndwalletInfo => {
                statusChange(walletAndwalletInfo?.account.address)
            } 
        );

        


    </script>
</body>
</html>